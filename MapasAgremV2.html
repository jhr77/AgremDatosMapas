<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa con Filtros Interactivos</title>
</head>
<body>
    <h2>Filtros</h2>
    <label for="departamento">Departamento:</label>
    <select id="departamento">
        <option value="">Todos</option>
    </select>

    <label for="ruta">Ruta:</label>
    <select id="ruta">
        <option value="">Todas</option>
    </select>

    <div id="map" style="height: 500px; width: 500%; margin-top: 20px;"></div>

    <script>
    let map, datos = [];

    // Inicializar el mapa
    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 4.6097, lng: -74.0817 },
            zoom: 7,
        });

        cargarDatos();
    }

    // Cargar datos desde Google Sheets y poblar filtros
    function cargarDatos() {
        const sheetURL = "https://opensheet.elk.sh/1EUNJK_ka7Dselo2d1FjI5QRyyIpUNjSOeqqa64oqC1o/DIMUBICACION";

        fetch(sheetURL)
            .then(response => response.json())
            .then(data => {
                datos = data;
                poblarFiltros(data);
                filtrarYMostrar();
            })
            .catch(error => console.error("Error al cargar los datos:", error));
    }

    // Poblar filtros con datos únicos
    function poblarFiltros(data) {
        const departamentos = new Set();
        const rutas = new Set();

        data.forEach(item => {
            if (item.DEPARTAMENTO) departamentos.add(item.DEPARTAMENTO);
            if (item.RUTAS) rutas.add(item.RUTAS);
        });

        departamentos.forEach(dep => {
            document.getElementById("departamento").innerHTML += `<option value="${dep}">${dep}</option>`;
        });

        rutas.forEach(ruta => {
            document.getElementById("ruta").innerHTML += `<option value="${ruta}">${ruta}</option>`;
        });

        // Agregar eventos a los filtros
        document.getElementById("departamento").addEventListener("change", filtrarYMostrar);
        document.getElementById("ruta").addEventListener("change", filtrarYMostrar);
    }

    // Filtrar datos según selección y mostrar en el mapa
    function filtrarYMostrar() {
        const filtroDepartamentos = document.getElementById("departamento").value;
        const filtroRutas = document.getElementById("ruta").value;

        // Limpiar el mapa
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 4.6097, lng: -74.0817 },
            zoom: 7,
        });

        datos.forEach(DIMUBICACION => {
            const departamento = DIMUBICACION.DEPARTAMENTO || '';
            const ruta = DIMUBICACION.RUTAS || '';

            if (
                (filtroDepartamentos === '' || departamento === filtroDepartamentos) &&
                (filtroRutas === '' || ruta === filtroRutas)
            ) {
                if (DIMUBICACION.latitud && DIMUBICACION.longitud) {
                    new google.maps.Marker({
                        position: { 
                            lat: parseFloat(DIMUBICACION.latitud), 
                            lng: parseFloat(DIMUBICACION.longitud) 
                        },
                        map,
                        icon: {
                            url: DIMUBICACION.icono || "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
                            scaledSize: new google.maps.Size(40, 40)
                        },
                        title: DIMUBICACION.EstadoRutasTramos || "Sin estado definido"
                    });
                }
            }
        });
    }
    </script>

    <!-- Carga optimizada de Google Maps API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjiXXT9ADpTsoIo1dIR-ECfLznlVnNM24&callback=initMap"></script>
</body>
</html>
